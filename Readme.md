# CTRL Your Documentation

## Purpose
CTRL Your Documentation intends to provide an up-to-date, hosted, documentation regarding what events are currently being collected through one's Google Tag Manager Server (GTMS). It provides a powerful possibility to validate events being received in GTMS are allowed and guarantee all events written to storage are with all necessary parameters.

In a nutshell: only documented events, with all required parameters properly formated and populated, will be firing it's tags. All is available in a web interface to provide a single point of interest for overviewing technical documentation of the events collected.
## How it works
In GTMS there's two added custom templates:
- CTRL Your Documentation client template
- Validate event variable template

The data for the documentation is stored in Google Cloud's Firestore. Each event is it's own document within a Firestore collection.

If needed, the setup can collect and store previously undocumented events for possible missed documentation. This data will be stored in the document *Undocumented* with the request parameters populated as a subfield for each undocumented event. 
### The client template
The client template will provide the HTML page where one can view the documentation stored in Firestore. Once the client is published, it will listen for undocumented events on the provided endpoint and cross reference the undocumented event to the collection in Firestore. If there isn't a match for the event, the event is written to Firestore along with a subitem containing a parsed version of the request. The parsed information is the GA4 event data object without any custom fields (starting with `x-`). This allows for a easier documentation for missed events or debugging if unknown events are sent to the GTMS. 

If enabled, the client can update the Firestore collection by the available form on the provided HTML file. Together with the actively listening, the page provides a clear CTA whenever an undocumented event is registered in Firestore. 

The client stores the responses from Firestore in its template cache. It limits the amount of reads made to Firestore as well as writes if the undocumented feature is enabled. The cache has a lifetime of 24 hours. While it's a necessary feature to limit the usage of the Firestore API, this introduces a side effect of different servers may serve different content. The cache is limited to each instance of the Google Tag Manager server which can produce different documentation depending on when server which responds to the request of the interface.
#### Benefits
- Documentation: all events are available for all in the organisation to see. All parameters along with example values and descriptions. 
- Live documentation: always be up-to-date with the events collected on site. If an analysts implements new tracking, the documentation is updated and available in realtime to all in the organisation with minimum effort.
- Hosted on server: always available as soon as the tracking is setup. It eliminates the need for separate files or systems to provide the interface.
- Easy to document: provides functionality to quickly generate the documentation needed to describe a newly implemented event and the required parameters with descriptions.
- Monitoring: enables monitoring of all collected events and notifies whenever an undocumented event is registered.
#### Setup
- (Required) The client needs a Firestore collection to read. The documents in this collection must not be empty, as it generates an error in the GTM Firestore API.
- (Optional) The client needs an endpoint to monitor for undocumented events.
- (Optional) The client requires to be prioritised above the intended claiming client for the endpoint for the undocumented function to work. 
  Example: if the received requests which is to be documented is GA4, then the client need to be prioritised at least one more than the claiming GA4 client. This is to read the incoming request without claiming it.
### The variable template
The variable template is used as a Transformation within Google Tag Manager. It should enhance all event data objects which is generated by the relevant client. The variable template adds a new parameter within the event data object which evaluates to `true` or `false`. Depending on if the event and it's added parameters are all according to the documentation specified in Firestore, i.e. the event name is documented and all parameters set as `required: true` is populated with a defined value in the event data object, the variable returns accordingly. This creates a whitelisting feature to only collect data which has been pre-defined and properly documented.
#### Benefits
- Whitelisting events: allow only for events with agreed upon documentation. Bots cannot send undocumented data which commonly missing important parameters.
- Quality assurance: Faulty tracking cannot contaminate or clutter collected data. All data collected has a clear purpose and data collected is making sure the data can deliver towards that purpose.
#### Setup
- (Required) The variable needs a Firestore collection to read. The documents in this collection must not be empty, as it generates an error in the GTM Firestore API.
- (Required) The variable set as an augumented event Transformation to append to all or some clients parsed event data objects.
- (Optional) Ability to chose what field in the event data object is to be parsed as the event name.
- (Optional) Triggers needs to be updated or an exclusion trigger added to each events to prevent the tag from firing and sending data to storage
### Google Cloud Firestore
Google Tag Manager server has a native integration to the Firestore API. It reads and writes data quickly onto a predetermined collection. This collection can be fully edited within the Google Cloud and this will be reflected in the documentation immediately (or, whenever the cache clears).

The API cannot handle an empty document. If data suddenly disappears from the documentation interface, please make sure no document in the collection is empty or has empty keys. The latter is most difficult to find.
#### Benefits
- Cheap: Firestore is fraction of a USD cent for each read, and slightly more for each write done. It's calculated *per 100 000* documents, so needless to say: it's very cheap.
- Easy setup: if setup in the same project as the Google Tag Manager servers, there's no need for authentication or service accounts. Straightforward setup of initiating the service in Google Cloud and creating the initial collection for documentation storage.
#### Setup
- (Required) Activate the service in Google Cloud.
  **Important**: the service must be activated as `Firestore in Native mode`. Datastore is not compatible. If it was created in `Datastore mode`, then all data has to be deleted before the project can switch to `Native mode`
- (Required) Create a collection named appropriately; `tracking_documentation`, `gtm_documentation` as examples
- (Optional) If the Firestore is to be in a separate project, then the service account of the Google Tag Manager server project needs to be added in the IAM. The service account is commonly named by the project ID first followed by generic host, e.g. `gtm-1a2b3c@appspot.gserviceaccount.com` 
## Next step
The setup is a v1.0. It serves the purpose of providing the whitelisting feature along with an interface of which anyone knowledgeable about the link to visit and overview along with document all events.

Possible next steps:
- Separate the client template and the generated page. The HTML file, along with the necessary CSS and JavaScript, is currently generated as a string within the client template. This makes it unnecessarily complicated to develop and maintain. The client should instead request the HTML file from a separate hosting location, preferably owned by CTRL Digital, and serve that file with the Firestore data attached.
- Introduce a password protection feature to safeguard the feature of adding events to the documentation. This is to limit people adding events which later can contaminate all the collected data.
- Integrate BigQuery runs to evaluate past event count and display as sparklines / warnings if event count dips unexpected.
- Update the cache logic for more robust handling of Firestore data retrieval and cross-instances updates.

